name: Deploy to CPanel

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json
    
    - name: Install and build frontend
      run: |
        cd frontend
        npm ci
        npm run build
        echo "âœ… Frontend build completed"
        
        # CRITICAL: Ensure ALL static assets are in dist
        echo "ğŸ“ Copying static assets from public to dist..."
        
        # Debug: Show what's in public directory
        echo "ğŸ“‚ Contents of public directory:"
        ls -la public/
        
        # Debug: Show what's in dist directory BEFORE copy
        echo "ğŸ“‚ Contents of dist directory BEFORE copy:"
        ls -la dist/
        
        # Copy ALL files from public to dist, including hidden files
        echo "ğŸ“‹ Copying files..."
        cp -r public/. dist/
        
        # Debug: Show what's in dist directory AFTER copy
        echo "ğŸ“‚ Contents of dist directory AFTER copy:"
        ls -la dist/
        
        # Also check for nested directories
        echo "ğŸ“‚ Checking locales directory:"
        ls -la dist/locales/ || echo "No locales directory"
        if [ -d dist/locales/tr ]; then
          echo "ğŸ“‚ Contents of locales/tr:"
          ls -la dist/locales/tr/
        fi
        
        echo "ğŸ“Š Frontend dist contents:"
        find dist -type f | sort
        echo "Total frontend files: $(find dist -type f | wc -l)"
        
    - name: Install and build backend
      run: |
        cd backend
        npm ci
        npm run build
        echo "âœ… Backend build completed"
        echo "ğŸ“Š Backend dist contents:"
        ls -la dist/
        
    - name: Prepare deployment package
      run: |
        # Create deployment directory
        mkdir -p deploy-package
        
        # Copy ALL frontend files to root of deploy package
        echo "ğŸ“¦ Copying frontend files..."
        # Use rsync to ensure ALL files are copied including hidden ones
        rsync -av frontend/dist/ deploy-package/
        
        # Create api directory and copy backend files
        echo "ğŸ“¦ Copying backend files..."
        mkdir -p deploy-package/api
        cp -r backend/dist/* deploy-package/api/
        cp backend/package.json deploy-package/api/
        cp backend/package-lock.json deploy-package/api/
        cp backend/app.js deploy-package/api/
        
        # Don't create .env file - use environment variables from cPanel instead
        echo "ğŸ“ Skipping .env file creation - using cPanel environment variables"
        
        echo "ğŸ“Š Final deployment package contents:"
        find deploy-package -type f | sort
        echo "Total files to deploy: $(find deploy-package -type f | wc -l)"
        
        # Verify critical files exist
        echo "ğŸ” Verifying critical files..."
        [ -f deploy-package/index.html ] && echo "âœ… index.html" || echo "âŒ index.html MISSING!"
        [ -f deploy-package/logo.png ] && echo "âœ… logo.png" || echo "âŒ logo.png MISSING!"
        [ -f deploy-package/vite.svg ] && echo "âœ… vite.svg" || echo "âŒ vite.svg MISSING!"
        [ -f deploy-package/.htaccess ] && echo "âœ… .htaccess" || echo "âŒ .htaccess MISSING!"
        [ -d deploy-package/locales/tr ] && echo "âœ… locales/tr directory" || echo "âŒ locales/tr directory MISSING!"
        [ -f deploy-package/locales/tr/common.json ] && echo "âœ… locales/tr/common.json" || echo "âŒ locales/tr/common.json MISSING!"
        
    - name: Deploy to CPanel via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.CPANEL_FTP_HOST }}
        username: ${{ secrets.CPANEL_FTP_USER }}
        password: ${{ secrets.CPANEL_FTP_PASSWORD }}
        local-dir: ./deploy-package/
        server-dir: public_html/
        dangerous-clean-slate: true
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.DS_Store
        
    - name: Verify Deployment
      run: |
        echo "ğŸ” Waiting for deployment to complete..."
        sleep 30
        
        echo "ğŸ“¡ Testing deployed files..."
        
        # Test with curl and show response
        echo -e "\nğŸ–¼ï¸ Testing logo.png..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://marinemanagementsystem.com/logo.png)
        [ "$response" = "200" ] && echo "âœ… logo.png is accessible (HTTP $response)" || echo "âŒ logo.png not found (HTTP $response)"
        
        echo -e "\nğŸ¨ Testing vite.svg..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://marinemanagementsystem.com/vite.svg)
        [ "$response" = "200" ] && echo "âœ… vite.svg is accessible (HTTP $response)" || echo "âŒ vite.svg not found (HTTP $response)"
        
        echo -e "\nğŸŒ Testing translation file..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://marinemanagementsystem.com/locales/tr/common.json)
        [ "$response" = "200" ] && echo "âœ… tr/common.json is accessible (HTTP $response)" || echo "âŒ tr/common.json not found (HTTP $response)"
        
        echo -e "\nğŸ¥ Testing API health..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://marinemanagementsystem.com/api/health)
        [ "$response" = "200" ] && echo "âœ… API is running (HTTP $response)" || echo "âŒ API not responding (HTTP $response)"
        
        echo -e "\nğŸ“‹ Deployment Summary:"
        echo "ğŸŒ Website: https://marinemanagementsystem.com"
        echo "ğŸ”— API: https://marinemanagementsystem.com/api/health"
        echo ""
        echo "âš ï¸ If API returns 404, please:"
        echo "1. Go to CPanel â†’ Setup Node.js App"
        echo "2. Click 'Restart' on your application"
        echo "3. Click 'Run NPM Install'" 